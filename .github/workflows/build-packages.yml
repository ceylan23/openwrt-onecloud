- name: 生成 feeds.conf.default（仅官方源）
  run: |
    cd openwrt
    cat > feeds.conf.default << EOF
    src-git packages https://git.openwrt.org/feed/packages.git
    src-git luci https://git.openwrt.org/project/luci.git
    src-git routing https://git.openwrt.org/feed/routing.git
    src-git telephony https://git.openwrt.org/feed/telephony.git
    EOF

- name: 更新并安装 feeds
  run: |
    cd openwrt
    ./scripts/feeds update -a
    ./scripts/feeds install -a

- name: 克隆插件源码
  run: |
    chmod +x $GITHUB_WORKSPACE/clone-plugins.sh
    $GITHUB_WORKSPACE/clone-plugins.sh

- name: 复制 .config
  run: cp $GITHUB_WORKSPACE/config.plugins openwrt/.config

- name: 生成配置并下载
  run: |
    cd openwrt
    make defconfig
    make download -j8

- name: 编译插件
  run: |
    cd openwrt
    make package/my/luci-app-openclash/compile -j$(nproc) V=s
    make package/my/luci-theme-argon/compile -j$(nproc) V=s
    make package/my/luci-app-mosdns/compile -j$(nproc) V=s
    # 如果 mosdns 主程序也有 Makefile，同样编译
    make package/my/mosdns/compile -j$(nproc) V=s || true
